<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="icon-parking.png">
<link rel="apple-touch-icon" href="icon-parking.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Pro - Julius</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Dise帽o Oscuro Premium */
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); max-width: 500px; margin: auto; border: 1px solid #333; }
        #map { height: 300px; width: 100%; border-radius: 10px; margin: 15px 0; border: 1px solid #444; }
        
        .timer-box { font-size: 1.3rem; font-weight: bold; color: #ff5252; margin: 10px 0; }
        input { padding: 12px; width: 80px; border-radius: 8px; border: 1px solid #444; background: #2c2c2c; color: white; text-align: center; font-size: 1rem; }
        
        button { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; width: 100%; margin: 8px 0; font-size: 1rem; }
        .btn-save { background-color: #00c853; color: white; }
        .btn-nav { background-color: #2979ff; color: white; }
        .btn-stop { background-color: #ff1744; color: white; display: none; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="card">
    <h2> Parking Julius Pro</h2>
    
    <button class="btn-save" onclick="iniciarEstacionamiento()"> Guardar Ubicaci贸n y Tiempo</button>
    
    <div style="margin: 15px 0;">
        <label>Tiempo parqu铆metro (minutos):</label><br>
        <input type="number" id="inputParquimetro" value="60">
    </div>

    <div class="timer-box" id="displayTiempo">Reloj listo</div>
    <div id="displayAlarma" style="color: #ffab40; font-weight: bold; min-height: 24px;"></div>

    <button id="btnDetener" class="btn-stop" onclick="detenerAlarma()"> DETENER ALARMA</button>

    <div id="map"></div>
    
    <button class="btn-nav" onclick="irAlAuto()">Л 驴C贸mo llegar al auto?</button>
</div>

<audio id="audioAlarma" loop>
    <source src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" type="audio/mpeg">
</audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let map, marker, startTime, interval;
    let carCoords = null;
    let alarmaYaSono = false; // Bandera para evitar que la alarma se repita tras detenerla
    
    const audio = document.getElementById('audioAlarma');
    const btnDetener = document.getElementById('btnDetener');

    function iniciarEstacionamiento() {
        if (!navigator.geolocation) return alert("GPS no soportado en este dispositivo");

        navigator.geolocation.getCurrentPosition(pos => {
            carCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            alarmaYaSono = false; // Resetear bandera para el nuevo ciclo
            
            // Inicializar o actualizar mapa
            if (!map) {
                map = L.map('map').setView([carCoords.lat, carCoords.lng], 17);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            if (marker) map.removeLayer(marker);
            marker = L.marker([carCoords.lat, carCoords.lng]).addTo(map);
            map.panTo([carCoords.lat, carCoords.lng]);

            // Iniciar cron贸metro
            startTime = new Date();
            if (interval) clearInterval(interval);
            interval = setInterval(actualizarEstado, 1000);
            
            // "Desbloquear" audio para el navegador
            audio.play().then(() => audio.pause()).catch(e => console.log("Audio esperando interacci贸n"));
            
            alert("隆Ubicaci贸n y parqu铆metro configurados!");
        }, () => {
            alert("Error: Por favor activa el GPS y permite el acceso a la ubicaci贸n.");
        }, { enableHighAccuracy: true });
    }

    function actualizarEstado() {
        if (!startTime) return;

        let ahora = new Date();
        let transcurrido = Math.floor((ahora - startTime) / 1000);
        let min = Math.floor(transcurrido / 60);
        let seg = transcurrido % 60;
        
        document.getElementById('displayTiempo').innerText = 
            `Llevas: ${min.toString().padStart(2,'0')}:${seg.toString().padStart(2,'0')}`;

        let tiempoTotal = parseInt(document.getElementById('inputParquimetro').value);
        let tiempoRestante = tiempoTotal - min;

        // Si faltan 5 minutos o menos y la alarma NO ha sonado en este ciclo
        if (tiempoRestante <= 5 && tiempoRestante >= 0 && !alarmaYaSono) {
            activarAlarma(tiempoRestante);
        }
    }

    function activarAlarma(minutos) {
        document.getElementById('displayAlarma').innerText = `锔 隆QUEDAN ${minutos} MINUTOS!`;
        btnDetener.style.display = 'block';
        
        // Sonido y Vibraci贸n
        audio.play();
        if ("vibrate" in navigator) {
            navigator.vibrate([500, 300, 500, 300, 500]);
        }
    }

    function detenerAlarma() {
        alarmaYaSono = true; // Marcamos que el usuario ya atendi贸 la alarma
        audio.pause();
        audio.currentTime = 0;
        if ("vibrate" in navigator) navigator.vibrate(0);
        
        btnDetener.style.display = 'none';
        document.getElementById('displayAlarma').innerText = "Alarma silenciada.";
    }

    function irAlAuto() {
        if (!carCoords) return alert("Primero debes guardar tu ubicaci贸n");
        const url = `https://www.google.com/maps/dir/?api=1&destination=${carCoords.lat},${carCoords.lng}&travelmode=walking`;
        window.open(url, '_blank');
    }
</script>
</body>
</html>
